# Distributed Attestation Implementation Plan\n\n## Overview\nImplement distributed attestation based on existing `secretGPT_attestai_1.0` infrastructure, where each spoke maintains verification capability while the hub provides coordination and discovery services.\n\n---\n\n## Architecture Overview\n\n### Distributed Attestation Model\n```\n┌─────────────────────────────────────────────────────────────┐\n│                    Boardroom TEE Hub                       │\n│  ┌─────────────────────────────────────────────────────┐   │\n│  │         Attestation Discovery Service               │   │\n│  │  • Registry of verified agents                      │   │\n│  │  • Attestation status coordination                  │   │\n│  │  • Event logging and audit trails                  │   │\n│  │  • Configuration management                        │   │\n│  └─────────────────────────────────────────────────────┘   │\n└─────────────────────────────────────────────────────────────┘\n                                │\n            ┌───────────────────┼───────────────────┐\n            │                   │                   │\n    ┌───────▼────────┐ ┌────────▼────────┐ ┌──────▼──────┐\n    │  Finance Agent │ │ Marketing Agent │ │ Sales Agent │\n    │ ┌────────────┐ │ │ ┌─────────────┐ │ │ ┌─────────┐ │\n    │ │Attestation │ │ │ │ Attestation │ │ │ │Attest.  │ │\n    │ │Verification│ │ │ │Verification │ │ │ │Verif.   │ │\n    │ │  Client    │ │ │ │   Client    │ │ │ │Client   │ │\n    │ └────────────┘ │ │ └─────────────┘ │ │ └─────────┘ │\n    └────────────────┘ └─────────────────┘ └─────────────┘\n            │                   │                   │\n            └─────────┬─────────┴─────────┬─────────┘\n                      │                   │\n                 Direct Attestation   Direct Attestation\n                  Verification        Verification\n```\n\n### Communication Flow\n1. **Each spoke maintains attestation verification capability**\n2. **Hub provides attestation coordination/discovery**\n3. **Spokes do direct attestation verification**\n4. **Hub logs attestation events for audit**\n\n---\n\n## Implementation Plan\n\n### Phase 1: Spoke Attestation Capability (2-3 weeks)\n\n#### 1.1 Adapt Existing Attestation Client\n**Source**: `F:/coding/secretGPT_attestai_1.0/services/attestation_hub/clients/hub_client.py`\n\n```python\n# New: spoke_attestation_client.py (adapted from existing hub_client.py)\nclass SpokeAttestationClient:\n    \"\"\"Attestation verification client for spoke agents\"\"\"\n    \n    def __init__(self, agent_id: str, hub_discovery_endpoint: str):\n        self.agent_id = agent_id\n        self.hub_endpoint = hub_discovery_endpoint\n        self.verification_cache = {}  # TTL-based cache\n        \n        # Adapt from existing AttestationHubClient\n        self.parser_factory = ParserFactory()\n        self.config = self.load_verification_config()\n    \n    async def verify_peer_attestation(self, peer_agent_id: str, \n                                     attestation_quote: str) -> bool:\n        \"\"\"Verify another spoke's attestation directly\"\"\"\n        # Adapt from existing get_attestation() method\n        # Use same parsing strategies as secretGPT hub\n        pass\n    \n    async def get_peer_discovery_info(self, peer_agent_id: str) -> Dict:\n        \"\"\"Get peer agent's current attestation info from hub registry\"\"\"\n        # Query hub discovery service for peer info\n        pass\n    \n    async def register_self_with_hub(self) -> bool:\n        \"\"\"Register this agent's attestation with hub discovery\"\"\"\n        # Similar to existing VM registration patterns\n        pass\n```\n\n#### 1.2 Integrate Attestation Parsers into Spokes\n**Source**: `F:/coding/secretGPT_attestai_1.0/services/attestation_hub/parsers/`\n\n```python\n# Each spoke gets these components from existing attestation hub:\n# - parsers/base.py (Parser interface)\n# - parsers/rest_server.py (secret-vm-attest-rest-server integration)\n# - parsers/hardcoded.py (Fallback byte-offset parsing)\n\n# Spoke agent integration:\nclass BaseSpokeAgent:\n    def __init__(self, agent_type: str):\n        self.agent_type = agent_type\n        self.attestation_client = SpokeAttestationClient(\n            agent_id=f\"{agent_type}-{client_id}\",\n            hub_discovery_endpoint=\"https://hub:8090/discovery\"\n        )\n    \n    async def verify_peer_before_collaboration(self, peer_agent_id: str) -> bool:\n        \"\"\"Verify peer attestation before accepting collaboration request\"\"\"\n        # Get peer's current attestation from hub discovery\n        peer_info = await self.attestation_client.get_peer_discovery_info(peer_agent_id)\n        \n        # Verify peer's attestation directly\n        return await self.attestation_client.verify_peer_attestation(\n            peer_agent_id, peer_info['attestation_quote']\n        )\n```\n\n#### 1.3 Docker Integration for Spokes\n```yaml\n# Update spoke docker-compose files\nservices:\n  finance-agent:\n    volumes:\n      # Existing SecretVM attestation\n      - ./crypto/docker_private_key_ed25519.pem:/app/crypto/privkey.pem\n      - ./crypto/docker_public_key_ed25519.pem:/app/crypto/pubkey.pem\n      - ./crypto/docker_attestation_ed25519.txt:/app/crypto/quote.txt\n      \n      # New: Attestation verification capability\n      - ./attestation_config:/app/attestation_config\n    \n    environment:\n      - AGENT_TYPE=finance\n      - HUB_DISCOVERY_ENDPOINT=https://hub:8090/discovery\n      - ATTESTATION_VERIFICATION_ENABLED=true\n      - ATTESTATION_CACHE_TTL=300  # 5 minutes\n```\n\n### Phase 2: Hub Discovery Service (1-2 weeks)\n\n#### 2.1 Attestation Discovery Service\n**Source**: Adapt from `F:/coding/secretGPT_attestai_1.0/services/attestation_hub/hub/service.py`\n\n```python\n# Add to existing hub service\nclass AttestationDiscoveryService:\n    \"\"\"Discovery and coordination service for distributed attestation\"\"\"\n    \n    def __init__(self):\n        # Adapt from existing AttestationHub class\n        self.agent_registry = {}  # Currently verified agents\n        self.attestation_cache = OrderedDict()  # TTL-based cache\n        self.audit_logger = AttestationAuditLogger()\n    \n    async def register_agent(self, agent_id: str, attestation_data: Dict) -> bool:\n        \"\"\"Register agent's current attestation status\"\"\"\n        # Adapt from existing get_attestation() validation logic\n        # Verify attestation before adding to registry\n        pass\n    \n    async def get_agent_discovery_info(self, agent_id: str) -> Dict:\n        \"\"\"Get agent's current attestation info for peer verification\"\"\"\n        # Similar to existing /attestation/{vm_name} endpoint\n        pass\n    \n    async def get_all_verified_agents(self) -> Dict:\n        \"\"\"Get list of currently verified agents\"\"\"\n        # Adapt from existing /attestation/all endpoint\n        pass\n    \n    async def log_attestation_event(self, event: Dict) -> None:\n        \"\"\"Log attestation verification events for audit\"\"\"\n        # New: Audit trail for distributed verification\n        pass\n```\n\n#### 2.2 Discovery API Endpoints\n```python\n# Add to existing hub API routes\n@router.get(\"/discovery/agents\")\nasync def get_verified_agents():\n    \"\"\"Get list of currently verified agents\"\"\"\n    # Adapt from existing /attestation/all\n    pass\n\n@router.get(\"/discovery/agent/{agent_id}\")\nasync def get_agent_attestation_info(agent_id: str):\n    \"\"\"Get specific agent's attestation info for verification\"\"\"\n    # Adapt from existing /attestation/{vm_name}\n    pass\n\n@router.post(\"/discovery/register\")\nasync def register_agent_attestation(request: AgentRegistrationRequest):\n    \"\"\"Register agent's attestation with discovery service\"\"\"\n    # New endpoint for agent self-registration\n    pass\n\n@router.post(\"/discovery/verify-event\")\nasync def log_verification_event(event: VerificationEvent):\n    \"\"\"Log attestation verification event for audit\"\"\"\n    # New endpoint for distributed verification logging\n    pass\n```\n\n### Phase 3: Direct Communication (2-3 weeks)\n\n#### 3.1 Direct Spoke-to-Spoke Communication\n```python\nclass SecureInterAgentCommunication:\n    \"\"\"Handle direct communication between verified spokes\"\"\"\n    \n    def __init__(self, attestation_client: SpokeAttestationClient):\n        self.attestation_client = attestation_client\n        self.communication_cache = {}\n    \n    async def send_verified_message(self, target_agent: str, \n                                   message: Dict) -> Dict:\n        \"\"\"Send message to another agent with attestation verification\"\"\"\n        try:\n            # 1. Verify target agent's current attestation\n            is_verified = await self.attestation_client.verify_peer_attestation(\n                target_agent, await self.get_target_attestation(target_agent)\n            )\n            \n            if not is_verified:\n                raise SecurityError(f\"Target agent {target_agent} attestation failed\")\n            \n            # 2. Send message directly to target agent\n            response = await self.direct_agent_request(target_agent, message)\n            \n            # 3. Log verification event with hub\n            await self.log_communication_event(target_agent, \"success\")\n            \n            return response\n            \n        except Exception as e:\n            await self.log_communication_event(target_agent, \"failed\", str(e))\n            raise\n    \n    async def get_target_attestation(self, target_agent: str) -> str:\n        \"\"\"Get target agent's current attestation from discovery service\"\"\"\n        discovery_info = await self.attestation_client.get_peer_discovery_info(target_agent)\n        return discovery_info['attestation_quote']\n    \n    async def direct_agent_request(self, target_agent: str, message: Dict) -> Dict:\n        \"\"\"Make direct HTTP request to target agent\"\"\"\n        # Direct agent-to-agent communication\n        # Include our attestation in request headers\n        pass\n```\n\n#### 3.2 Network Routing Configuration\n```yaml\n# Update docker network for direct communication\nnetworks:\n  boardroom-network:\n    driver: bridge\n    ipam:\n      config:\n        - subnet: 172.20.0.0/16\n          \nservices:\n  hub:\n    networks:\n      boardroom-network:\n        ipv4_address: 172.20.0.10\n        \n  finance-agent:\n    networks:\n      boardroom-network:\n        ipv4_address: 172.20.0.11\n        \n  marketing-agent:\n    networks:\n      boardroom-network:\n        ipv4_address: 172.20.0.12\n```\n\n### Phase 4: Integration & Testing (1-2 weeks)\n\n#### 4.1 End-to-End Testing Framework\n```python\nclass DistributedAttestationTests:\n    \"\"\"Test distributed attestation functionality\"\"\"\n    \n    async def test_spoke_to_spoke_verification(self):\n        \"\"\"Test direct spoke attestation verification\"\"\"\n        # Verify finance agent can verify marketing agent directly\n        pass\n    \n    async def test_discovery_service_integration(self):\n        \"\"\"Test hub discovery service coordination\"\"\"\n        # Verify agents can discover each other through hub\n        pass\n    \n    async def test_audit_trail_logging(self):\n        \"\"\"Test audit event logging\"\"\"\n        # Verify all attestation events are logged properly\n        pass\n    \n    async def test_failure_scenarios(self):\n        \"\"\"Test handling of attestation failures\"\"\"\n        # Verify proper handling when attestation fails\n        pass\n```\n\n#### 4.2 Monitoring and Alerting\n```python\n# Adapt from existing monitoring in secretGPT attestation hub\nclass DistributedAttestationMonitoring:\n    \"\"\"Monitor distributed attestation health\"\"\"\n    \n    def __init__(self):\n        self.metrics = {\n            \"verification_success_rate\": 0,\n            \"average_verification_time\": 0,\n            \"failed_verifications\": 0,\n            \"agent_availability\": {}\n        }\n    \n    async def track_verification_event(self, event: Dict):\n        \"\"\"Track attestation verification metrics\"\"\"\n        # Update metrics based on verification events\n        pass\n    \n    async def check_agent_health(self) -> Dict:\n        \"\"\"Check health of all agents in network\"\"\"\n        # Query discovery service for agent status\n        pass\n```\n\n---\n\n## Configuration Management\n\n### Agent Attestation Configuration\n**Source**: Adapt from `F:/coding/secretGPT_attestai_1.0/services/attestation_hub/config/vm_configs.yaml`\n\n```yaml\n# config/boardroom_attestation.yaml\nagents:\n  finance:\n    endpoint: \"https://finance-agent:8081\"\n    attestation_endpoint: \"https://finance-agent:29344\"\n    type: \"finance-specialist\"\n    parsing_strategy: \"rest_server\"\n    fallback_strategy: \"hardcoded\"\n    timeout: 30\n    expected_measurements:\n      # These would be the actual measurements for finance agent\n      mrtd: \"ba87a347454466680bfd267446df89d8117c04ea9f28234dd3d84e1a8a957d5adaf02d4aa88433b559fb13bd40f0109e\"\n      rtmr0: \"090cb75d89b6fc13e37816f76b1ee1eb4c52fb9aae2b161b70982e87c41ae62e37fd285f9d0c597140305736748d5f7f\"\n      # ... other RTMRs\n  \n  marketing:\n    endpoint: \"https://marketing-agent:8082\"\n    attestation_endpoint: \"https://marketing-agent:29345\"\n    type: \"marketing-specialist\"\n    parsing_strategy: \"rest_server\"\n    fallback_strategy: \"hardcoded\"\n    timeout: 30\n    expected_measurements:\n      # Marketing agent measurements\n      mrtd: \"[marketing_agent_mrtd]\"\n      rtmr0: \"[marketing_agent_rtmr0]\"\n      # ... other RTMRs\n```\n\n### Discovery Service Configuration\n```yaml\n# config/discovery_service.yaml\ndiscovery:\n  cache_ttl: 300  # 5 minutes\n  max_agents: 10\n  verification_timeout: 30\n  audit_logging: true\n  \naudit:\n  log_level: \"INFO\"\n  log_file: \"/app/logs/attestation_audit.log\"\n  retention_days: 90\n  \nnetwork:\n  direct_communication: true\n  hub_coordination: true\n  fallback_to_hub_proxy: false\n```\n\n---\n\n## Integration with Existing Components\n\n### Hub Service Integration\n```python\n# Update existing UnifiedHubService\nclass UnifiedHubService:\n    def __init__(self):\n        self.hub_llm = UnifiedHubLLM()\n        self.document_processor = DocumentCategorizer(self.hub_llm)\n        self.agent_orchestrator = AgentOrchestrator(self.hub_llm)\n        \n        # New: Attestation discovery service\n        self.attestation_discovery = AttestationDiscoveryService()\n        \n    async def handle_agent_collaboration_request(self, request: Dict):\n        \"\"\"Handle agent collaboration with distributed attestation\"\"\"\n        try:\n            # 1. Route the request using LLM\n            routing_decision = self.agent_orchestrator.route_agent_request(\n                request['query'], request['requesting_agent']\n            )\n            \n            # 2. Verify all target agents are currently verified\n            for agent_config in routing_decision['agents']:\n                agent_status = await self.attestation_discovery.get_agent_discovery_info(\n                    agent_config['agent']\n                )\n                if not agent_status['verified']:\n                    raise SecurityError(f\"Agent {agent_config['agent']} not verified\")\n            \n            # 3. Return routing with attestation verification status\n            routing_decision['attestation_verified'] = True\n            return {\n                \"status\": \"success\",\n                \"routing_decision\": routing_decision\n            }\n            \n        except Exception as e:\n            return {\n                \"status\": \"error\",\n                \"error\": str(e)\n            }\n```\n\n### Spoke Agent Base Class Updates\n```python\n# Update existing spoke agent framework\nclass BaseSpokeAgent:\n    def __init__(self, agent_type: str, client_id: str):\n        self.agent_type = agent_type\n        self.client_id = client_id\n        \n        # Existing components\n        self.hub_client = HubClient()\n        \n        # New: Attestation verification capability\n        self.attestation_client = SpokeAttestationClient(\n            agent_id=f\"{agent_type}-{client_id}\",\n            hub_discovery_endpoint=\"https://hub:8090/discovery\"\n        )\n        self.secure_communication = SecureInterAgentCommunication(self.attestation_client)\n        \n    async def collaborate_with_agent(self, target_agent: str, request: Dict) -> Dict:\n        \"\"\"Collaborate with another agent using distributed attestation\"\"\"\n        try:\n            # Use secure communication with attestation verification\n            response = await self.secure_communication.send_verified_message(\n                target_agent, request\n            )\n            return response\n            \n        except SecurityError as e:\n            # Handle attestation verification failures\n            return {\n                \"status\": \"error\",\n                \"error\": f\"Attestation verification failed: {str(e)}\"\n            }\n```\n\n---\n\n## Deployment Updates\n\n### Hub Docker Compose Updates\n```yaml\n# hub/docker-compose.yaml additions\nservices:\n  boardroom-hub:\n    ports:\n      - \"8080:8080\"      # Main API\n      - \"29343:29343\"    # Hub attestation endpoint\n      - \"8090:8090\"      # New: Discovery service API\n    \n    environment:\n      - HUB_MODEL_NAME=meta-llama/Llama-3.2-1B-Instruct\n      - HUB_MAX_MEMORY_MB=3000\n      # New: Discovery service config\n      - DISCOVERY_SERVICE_ENABLED=true\n      - DISCOVERY_CACHE_TTL=300\n      - ATTESTATION_AUDIT_LOGGING=true\n    \n    volumes:\n      # Existing volumes...\n      # New: Attestation configuration\n      - ./config/boardroom_attestation.yaml:/app/config/attestation.yaml\n      - ./config/discovery_service.yaml:/app/config/discovery.yaml\n```\n\n### Spoke Docker Compose Updates\n```yaml\n# spoke_*/docker-compose.yaml additions\nservices:\n  finance-agent:  # (or marketing-agent, sales-agent, etc.)\n    environment:\n      # Existing environment variables...\n      # New: Attestation verification config\n      - ATTESTATION_VERIFICATION_ENABLED=true\n      - HUB_DISCOVERY_ENDPOINT=https://hub:8090/discovery\n      - PEER_VERIFICATION_CACHE_TTL=300\n      - DIRECT_COMMUNICATION_ENABLED=true\n    \n    volumes:\n      # Existing volumes...\n      # New: Attestation verification capability\n      - ./config/attestation_verification.yaml:/app/config/attestation.yaml\n```\n\n---\n\n## Success Criteria & Testing\n\n### Phase 1 Success Criteria\n- [ ] Each spoke can verify other spokes' attestations independently\n- [ ] Attestation verification uses existing secretGPT parsing logic\n- [ ] Spokes can cache attestation verification results\n- [ ] All existing SecretVM attestation functionality preserved\n\n### Phase 2 Success Criteria\n- [ ] Hub discovery service maintains registry of verified agents\n- [ ] Spokes can query hub for peer attestation information\n- [ ] Hub logs all attestation events for audit\n- [ ] Discovery service has 99%+ uptime\n\n### Phase 3 Success Criteria\n- [ ] Spokes communicate directly after attestation verification\n- [ ] Direct communication bypasses hub for data transfer\n- [ ] All communications include attestation verification\n- [ ] Network routing enables direct spoke-to-spoke connections\n\n### Phase 4 Success Criteria\n- [ ] End-to-end attestation verification working reliably\n- [ ] Comprehensive audit trail of all attestation events\n- [ ] Performance meets targets (< 5 second verification)\n- [ ] Monitoring and alerting operational\n\n---\n\n## Timeline Summary\n\n**Total Estimated Time: 6-10 weeks**\n\n- **Phase 1**: Spoke Attestation Capability (2-3 weeks)\n- **Phase 2**: Hub Discovery Service (1-2 weeks)\n- **Phase 3**: Direct Communication (2-3 weeks)\n- **Phase 4**: Integration & Testing (1-2 weeks)\n\n**Risk Factors:**\n- Network configuration complexity\n- Integration with existing SecretVM attestation\n- Performance optimization for real-time verification\n- Debugging distributed system interactions\n\n**Mitigation Strategies:**\n- Reuse maximum amount of existing secretGPT attestation code\n- Implement comprehensive testing at each phase\n- Plan for fallback to hub-mediated communication if direct fails\n- Gradual rollout with monitoring at each step\n\n---\n\n*Last Updated: [Current Date]*  \n*Related: hub_data_processing.md, agent_collaboration.md, spoke_agents.md*\n*Reference: secretGPT_attestai_1.0/services/attestation_hub/*